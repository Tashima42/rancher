name: Provisioning tests
on:
  workflow_dispatch:
jobs:
  provisioning_tests:
    strategy:
      fail-fast: false
      matrix:
        test:
        - "General_SystemAgentVersion"
        # - "General_WinsAgentVersion"
        # - "General_CSIProxyAgentVersion"
        # - "Provisioning_Custom_OneNodeWithDelete"
        # - "Provisioning_Custom_ThreeNode"
        # - "Provisioning_Custom_UniqueRoles"
        # - "Provisioning_Custom_ThreeNodeWithTaints"
        # - "Fleet_Cluster"
        # - "Fleet_ClusterBootstrap"
    name: Provisioning tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Say hello
        run: echo "Running tests"
      - name: Install Dapper
        run: |
          curl -sL https://releases.rancher.com/dapper/latest/dapper-$(uname -s)-$(uname -m) > /usr/local/bin/dapper
          chmod +x /usr/local/bin/dapper
      - name: Dapper version
        run: dapper --version
      - name: Docker version
        run: docker version
      - name: Run dapper
        run: dapper provisioning-tests
        env:
          V2PROV_TEST_RUN_REGEX: "^Test_${{ matrix.test }}.*"
      - name: Output size of rancher.log
        if: always()
        run: |
          if [ -f ./build/testdata/rancher.log ]; then
            echo "Size of rancher.log:"
            stat --format="%s bytes" ./build/testdata/rancher.log
          else
            echo "rancher.log does not exist."
          fi
      
      - name: Output size of k3s.log
        if: always()
        run: |
          if [ -f ./build/testdata/k3s.log ]; then
            echo "Size of k3s.log:"
            stat --format="%s bytes" ./build/testdata/k3s.log
          else
            echo "k3s.log does not exist."
          fi
      - name: Upload a rancher log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.test }}-rancher.log
          path: ./build/testdata/rancher.log
  
      - name: Upload k3s log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.test }}-k3s.log
          path: ./build/testdata/k3s.log
      - name: Say goodbye
        run: |
          docker ps -a
          docker image ls
          docker image ls -a
          docker system prune -f
          docker image ls -a
          docker system prune -a -f
          docker system prune -a -f --volumes
      - name: Say goodbye
        run: echo "Tests completed"
